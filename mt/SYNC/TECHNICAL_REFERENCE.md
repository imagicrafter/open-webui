# SQLite + Supabase Sync System - Technical Reference

**Last Updated**: 2025-10-10
**Status**: Phase 1 Implementation
**Purpose**: Single source of truth for implementation standards, naming conventions, and file locations

---

## 🎯 Critical: Read This First

**This document defines mandatory standards for ALL code in the sync system.**

Before modifying ANY file in `mt/SYNC/`:
1. Read the relevant section below
2. Follow the exact naming conventions
3. Update this document if you add new standards
4. Never create inconsistencies with existing patterns

---

## 📁 File Locations & Paths

### Standard Directory Structure

```
mt/SYNC/
├── .credentials              # ← CREDENTIALS FILE LOCATION (git-ignored)
├── README.md                 # User-facing documentation
├── TECHNICAL_REFERENCE.md    # ← THIS FILE (implementation standards)
├── IMPLEMENTATION_STATUS.md  # Project progress tracking
├── CLUSTER_LIFECYCLE_FAQ.md  # Operational Q&A
│
├── config/
│   ├── conflict-resolution-default.json
│   └── sync-config-template.env
│
├── docker/
│   ├── .env                  # Generated by deploy script
│   ├── Dockerfile
│   ├── entrypoint.sh
│   ├── docker-compose.sync-ha.yml
│   └── logs/                 # Container logs
│
├── python/
│   ├── __init__.py
│   ├── main.py               # FastAPI application
│   ├── leader_election.py
│   ├── state_manager.py
│   ├── conflict_resolver.py
│   └── metrics.py
│
├── scripts/
│   ├── deploy-sync-cluster.sh
│   ├── deregister-cluster.sh
│   └── sync-client-to-supabase.sh
│
└── tests/
    └── (test scripts - not yet implemented)
```

### Critical Path Patterns

**When referencing paths in scripts:**

```bash
# ALWAYS use these patterns:
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SYNC_DIR="$(dirname "$SCRIPT_DIR")"              # Parent of scripts/

# Standard subdirectories:
DOCKER_DIR="$SYNC_DIR/docker"
CONFIG_DIR="$SYNC_DIR/config"
PYTHON_DIR="$SYNC_DIR/python"

# Credentials file (CRITICAL - see section below):
CREDENTIALS_FILE="$SYNC_DIR/.credentials"         # ← NOT in docker/ subdirectory

# Environment file (for Docker Compose):
ENV_FILE="$DOCKER_DIR/.env"
```

**Docker Compose working directory:**

```bash
# When running docker-compose commands:
cd "$DOCKER_DIR"
docker compose -f docker-compose.sync-ha.yml up -d
```

---

## 🔐 Credentials & Environment Variables

### Credentials File (.credentials)

**Location**: `mt/SYNC/.credentials` (root of SYNC directory)
**Created By**: `scripts/deploy-sync-cluster.sh`
**Used By**: `scripts/deregister-cluster.sh`, manual operations
**Permissions**: `chmod 600` (owner read/write only)
**Git Status**: Ignored (in .gitignore)

**Standard Variable Names** (MANDATORY):

```bash
# Supabase Project Info
SUPABASE_PROJECT_REF=abc123xyz         # Project reference ID
SUPABASE_REGION=aws-0-us-east-1        # Region identifier

# Passwords (plain text, NOT URL-encoded)
SYNC_SERVICE_PASSWORD=generated_password_here

# Connection URLs (URL-encoded passwords)
ADMIN_URL=postgresql://postgres:URL_ENCODED_PASSWORD@host:5432/postgres
SYNC_URL=postgresql://sync_service:URL_ENCODED_PASSWORD@host:5432/postgres
```

**CRITICAL**: When reading `.credentials` in scripts:

```bash
source "$SYNC_DIR/.credentials"

# The file provides: ADMIN_URL and SYNC_URL
# If your script needs different variable names, assign them:
SUPABASE_ADMIN_URL="$ADMIN_URL"
DATABASE_URL="$SYNC_URL"
```

### Environment File (.env)

**Location**: `mt/SYNC/docker/.env`
**Created By**: `scripts/deploy-sync-cluster.sh`
**Used By**: `docker-compose.sync-ha.yml`
**Permissions**: `chmod 600`
**Git Status**: Ignored (in .gitignore)

**Standard Variable Names** (MANDATORY):

```bash
# Database Connection (uses SYNC_URL from .credentials)
SUPABASE_URL=postgresql://sync_service:PASSWORD@host:5432/postgres

# Host Configuration
HOST_NAME=prod-host-1

# Sync Settings
CACHE_TTL=300
HEARTBEAT_INTERVAL=30
LEASE_DURATION=60
LOG_LEVEL=INFO
LOG_FORMAT=json
BATCH_SIZE=1000

# Monitoring
ENABLE_METRICS=true
```

### Python Environment Variables

**Read by**: `python/main.py`, `python/leader_election.py`, etc.

```python
# Access via os.environ - use these EXACT names:
DATABASE_URL = os.environ["DATABASE_URL"]          # From docker-compose
CLUSTER_NAME = os.environ["CLUSTER_NAME"]
ROLE = os.environ["ROLE"]                          # "node-a" or "node-b"
API_PORT = int(os.environ.get("API_PORT", "9443"))
CACHE_TTL = int(os.environ.get("CACHE_TTL", "300"))
HEARTBEAT_INTERVAL = int(os.environ.get("HEARTBEAT_INTERVAL", "30"))
LEASE_DURATION = int(os.environ.get("LEASE_DURATION", "60"))
```

---

## 🐳 Container Naming Standards

### Container Names (FIXED - Do Not Change)

```yaml
# In docker-compose.sync-ha.yml:
services:
  sync-node-a:
    container_name: openwebui-sync-node-a    # ← FIXED NAME
    environment:
      - ROLE=node-a                           # ← ROLE IDENTIFIER
      - API_PORT=9443

  sync-node-b:
    container_name: openwebui-sync-node-b    # ← FIXED NAME
    environment:
      - ROLE=node-b                           # ← ROLE IDENTIFIER
      - API_PORT=9444
```

**CRITICAL RULES**:

1. **Container names are FIXED** and do NOT change based on leadership
2. **Container names do NOT determine leader** - PostgreSQL does
3. **Leadership is DYNAMIC** - either node can be leader
4. Use `node-a` and `node-b` (neutral names, NOT primary/secondary)

### When Referencing Containers in Scripts

```bash
# Correct:
docker stop openwebui-sync-node-a openwebui-sync-node-b

# Wrong:
docker stop openwebui-sync-primary openwebui-sync-secondary  # ❌ Old names
```

### Leader Identification

**DO NOT** rely on container names to determine leader. **ALWAYS** query the database:

```sql
-- Source of truth for leadership:
SELECT leader_id, expires_at
FROM sync_metadata.leader_election
WHERE cluster_name = 'YOUR_CLUSTER';
```

**Or** use the health API:

```bash
# Check which container is currently leader:
curl http://localhost:9443/health | jq '.is_leader'  # true or false
curl http://localhost:9444/health | jq '.is_leader'  # true or false
```

---

## 🗄️ Database Naming Standards

### Schema & Tables

**Schema**: `sync_metadata` (all tables in this schema)

**Tables** (exact names):
- `sync_metadata.hosts`
- `sync_metadata.client_deployments`
- `sync_metadata.leader_election`
- `sync_metadata.conflict_log`
- `sync_metadata.cache_events`
- `sync_metadata.sync_jobs`
- `sync_metadata.sync_progress`

**Views**:
- `sync_metadata.v_cluster_health`
- `sync_metadata.v_sync_status`
- `sync_metadata.v_conflict_summary`

### Column Naming Conventions

**Primary Keys**: `{table_name}_id` (e.g., `host_id`, `deployment_id`)

**Timestamps**: Use PostgreSQL `TIMESTAMPTZ`
- `created_at` - Record creation time
- `updated_at` - Last modification time
- `last_heartbeat` - Last successful heartbeat
- `acquired_at` - When lease was acquired
- `expires_at` - When lease expires
- `last_sync_at` - Last successful sync

**Foreign Keys**: Match the referenced table's primary key name
- `host_id` references `hosts.host_id`
- `deployment_id` references `client_deployments.deployment_id`

**Status Fields**: Use lowercase with underscores
- `status` - General status field (e.g., 'active', 'offline', 'failed')
- `sync_enabled` - Boolean for sync state
- `is_leader` - Boolean for leader status (computed, not stored)

### Database Role

**Service Role**: `sync_service` (NOT `sync_user` or `sync_role`)

**Permissions** (enforced in `02-create-sync-role.sql`):
- ✅ SELECT, INSERT, UPDATE on all `sync_metadata` tables
- ❌ NO DELETE permission (security requirement)
- ❌ NOT a superuser
- ✅ Can execute helper functions

---

## 🔌 API Endpoints & Ports

### Port Assignments

**FIXED PORT MAPPING**:
- Node A: `9443` (host) → `9443` (container)
- Node B: `9444` (host) → `9444` (container)

**DO NOT** change these ports without updating:
- `docker-compose.sync-ha.yml`
- `README.md` examples
- Health check scripts
- Monitoring configurations

### Standard API Endpoints

**All endpoints are available on BOTH containers:**

```
Health & Status:
  GET  /health                           # Container health + leader status
  GET  /api/v1/cluster/status            # Full cluster status
  GET  /metrics                          # Prometheus metrics

State Management:
  GET  /api/v1/state/{key}               # Get cached state
  PUT  /api/v1/state/{key}               # Update state (leader writes to DB)

Sync Operations:
  POST /api/v1/sync/trigger              # Trigger manual sync (leader only)
  GET  /api/v1/conflicts                 # Get unresolved conflicts
```

### Health Check Response Format

```json
{
  "status": "healthy",
  "is_leader": true,
  "node_id": "openwebui-sync-node-a",
  "cluster_name": "prod-host-1",
  "uptime_seconds": 3600
}
```

---

## 🔄 Sync Script Standards

### sync-client-to-supabase.sh

**Required Environment Variables**:
```bash
DATABASE_URL          # Supabase connection URL
CLIENT_NAME           # Client identifier
CONTAINER_NAME        # Docker container name
```

**Standard Exit Codes**:
- `0` - Success (sync completed)
- `1` - Fatal error (configuration, connection, etc.)
- `2` - Conflicts detected (requires manual resolution)

**Logging Format**:
```bash
echo "[$(date -Iseconds)] INFO: Starting sync for $CLIENT_NAME"
echo "[$(date -Iseconds)] ERROR: Failed to connect to database"
```

---

## 📊 Metrics Naming

### Prometheus Metric Names

**Prefix**: All metrics start with `sync_`

**Standard Metrics**:
```
# Leader Election
sync_leader_election_attempts_total
sync_leader_election_successes_total
sync_leader_election_failures_total
sync_is_leader (gauge, 0 or 1)

# Sync Operations
sync_operations_total{status="success|failed"}
sync_operation_duration_seconds (histogram)
sync_rows_synced_total

# Conflicts
sync_conflicts_detected_total
sync_conflicts_resolved_total{strategy="newest_wins|source_wins|..."}

# Cache
sync_cache_hits_total
sync_cache_misses_total
sync_cache_evictions_total
```

---

## 🛡️ Security Standards

### Credential Handling

**DO**:
- ✅ Store credentials in `.credentials` file (root of SYNC dir)
- ✅ Use `chmod 600` for all credential files
- ✅ URL-encode passwords when building connection strings
- ✅ Use separate admin and service passwords

**DON'T**:
- ❌ Hardcode credentials in scripts
- ❌ Commit `.credentials` or `.env` files to git
- ❌ Share service role credentials with clients
- ❌ Grant DELETE permission to `sync_service` role

### Password URL Encoding

**When building PostgreSQL URLs**:

```bash
# Use the urlencode function from deploy-sync-cluster.sh:
urlencode() {
    local string="${1}"
    local strlen=${#string}
    local encoded=""
    local pos c o

    for (( pos=0 ; pos<strlen ; pos++ )); do
        c=${string:$pos:1}
        case "$c" in
            [-_.~a-zA-Z0-9] ) o="${c}" ;;
            * ) printf -v o '%%%02x' "'$c"
        esac
        encoded+="${o}"
    done
    echo "${encoded}"
}

# Use it:
ENCODED_PASSWORD=$(urlencode "$PLAIN_PASSWORD")
DATABASE_URL="postgresql://user:${ENCODED_PASSWORD}@host:5432/db"
```

---

## 📝 Documentation Standards

### File Headers

**All shell scripts** must have this header format:

```bash
#!/bin/bash
# SQLite + Supabase Sync System - [Script Purpose]
# [Additional context or warnings]
#
# [Brief description of what the script does]

set -euo pipefail
```

**All Python files** must have this header:

```python
"""
SQLite + Supabase Sync System - [Module Name]

[Brief description of module purpose]
"""

import ...
```

### Comment Standards

**Shell Scripts**:
```bash
# ============================================================================
# Major Section Name
# ============================================================================

# Subsection explanation
echo "Starting process..."

# Inline comment for complex line
RESULT=$(complex_command | grep pattern)  # Extract specific pattern
```

**Python**:
```python
# Type hints required for all functions
async def function_name(param: str, count: int = 10) -> bool:
    """
    Brief one-line description.

    Args:
        param: Description of parameter
        count: Description with default value

    Returns:
        Description of return value
    """
```

---

## 🔧 Version Control Standards

### Files That MUST Be Git-Ignored

```gitignore
# In mt/SYNC/.gitignore:
.credentials
docker/.env
docker/logs/
*.pyc
__pycache__/
.pytest_cache/
```

### Commit Message Format

```
[component] Brief description

Detailed explanation if needed.

- Change 1
- Change 2

Closes: #issue_number (if applicable)
```

**Examples**:
```
[scripts] Fix credentials file path in deregister script

The deregister script was looking for .credentials in docker/
subdirectory but deploy script creates it in SYNC root.

- Updated CREDENTIALS_FILE path to ${SYNC_DIR}/.credentials
- Added variable name mapping (ADMIN_URL → SUPABASE_ADMIN_URL)
```

---

## 🧪 Testing Standards

### Test File Naming

```bash
tests/
├── test-ha-failover.sh           # Test leader election and failover
├── test-conflict-resolution.sh   # Test conflict strategies
├── test-state-authority.sh       # Test Supabase as source of truth
└── test-security.sh              # Test permissions and RLS
```

### Test Exit Codes

- `0` - All tests passed
- `1` - One or more tests failed
- `2` - Test environment setup failed

---

## 🚨 Error Handling Standards

### Shell Script Error Functions

**Use these standard functions** (copy from deregister-cluster.sh):

```bash
error() {
    echo "❌ ERROR: $1" >&2
    exit 1
}

warn() {
    echo "⚠️  WARNING: $1" >&2
}

info() {
    echo "ℹ️  $1"
}

success() {
    echo "✅ $1"
}
```

### Python Exception Handling

```python
# Custom exceptions in python/exceptions.py (create if needed)
class SyncSystemError(Exception):
    """Base exception for sync system"""
    pass

class LeaderElectionError(SyncSystemError):
    """Raised when leader election fails"""
    pass

class ConflictResolutionError(SyncSystemError):
    """Raised when conflict resolution fails"""
    pass
```

---

## 🔄 Update Procedures

### When Adding New Features

1. **Before coding**: Read this document
2. **During coding**: Follow all standards exactly
3. **After coding**: Update this document with any new patterns
4. **Before commit**: Verify consistency with existing code

### When Modifying Existing Code

1. Check if variable names or paths are defined here
2. If changing a standard, update ALL affected files
3. Update this document with the new standard
4. Document the reason for the change in commit message

### Document Update Template

When adding a new section to this document:

```markdown
## [New Category]

**Purpose**: Brief explanation of why this standard exists

**Standard Pattern**:
[Code example of the standard]

**CRITICAL RULES**:
1. [Rule 1]
2. [Rule 2]

**Common Mistakes**:
- ❌ [What NOT to do]
- ✅ [What to do instead]
```

---

## 📚 Related Documentation

**Read these in order for new developers**:

1. **TECHNICAL_REFERENCE.md** (this file) - Implementation standards
2. **README.md** - Architecture and user-facing documentation
3. **IMPLEMENTATION_STATUS.md** - Current project progress
4. **CLUSTER_LIFECYCLE_FAQ.md** - Operational procedures

**For specific tasks**:
- Deployment: `scripts/deploy-sync-cluster.sh` + README.md
- Deregistration: `scripts/deregister-cluster.sh` + CLUSTER_LIFECYCLE_FAQ.md
- API Integration: README.md API section + `python/main.py`
- Database Schema: `scripts/01-init-sync-schema.sql`

---

## ✅ Pre-Commit Checklist

Before committing ANY changes to `mt/SYNC/`:

- [ ] All variable names match TECHNICAL_REFERENCE.md standards
- [ ] All file paths use standard patterns from this document
- [ ] No hardcoded credentials
- [ ] `.credentials` and `.env` are git-ignored
- [ ] Container names use `node-a` / `node-b` pattern
- [ ] Database queries use exact table/column names from this doc
- [ ] New patterns added to this document if created
- [ ] All affected files updated consistently
- [ ] Related documentation updated

---

## 🎓 Common Patterns Quick Reference

```bash
# Script initialization
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SYNC_DIR="$(dirname "$SCRIPT_DIR")"

# Load credentials
source "$SYNC_DIR/.credentials"
SUPABASE_ADMIN_URL="$ADMIN_URL"  # Map to script variable name

# Reference containers
docker stop openwebui-sync-node-a openwebui-sync-node-b

# Check leadership (don't rely on container names!)
curl http://localhost:9443/health | jq '.is_leader'

# Query database
docker run --rm postgres:15-alpine psql "$SUPABASE_ADMIN_URL" -c \
    "SELECT * FROM sync_metadata.leader_election WHERE cluster_name = '$CLUSTER_NAME';"
```

---

**Last Updated**: 2025-10-10
**Maintainers**: Reference Archon project `038661b1-7e1c-40d0-b4f9-950db24c2a3f`
**Version**: 1.0 (Phase 1)

---

## Document Changelog

### 2025-10-10 - Initial Creation
- Created comprehensive technical reference
- Documented all current standards and patterns
- Added credentials file location fix (SYNC root, not docker/)
- Added variable name mapping standards (ADMIN_URL → SUPABASE_ADMIN_URL)

---

## 🔧 System-Level Operations and Permissions

### Deployment Scripts Require Elevated Privileges

**CRITICAL REQUIREMENT**: Deployment scripts that modify system-level configuration (Docker daemon, systemd services, /etc directories) **MUST** use sudo for privileged operations.

**Problem Identified (2025-10-11)**:
- Original deploy-sync-cluster.sh attempted to write to /etc/docker/daemon.json without sudo
- Shell redirection (cat >) and tee commands failed with "Permission denied"
- System commands (systemctl, file operations in /etc) require root privileges

**Mandatory Pattern for System Operations**:

```bash
# WRONG - Will fail with permission denied
echo 'config' > /etc/docker/daemon.json
systemctl restart docker

# CORRECT - Use sudo for system operations  
echo 'config' | sudo tee /etc/docker/daemon.json > /dev/null
sudo systemctl restart docker
```

**System Commands Requiring sudo**:
1. File operations in /etc/docker/, /etc/systemd/, or any root-owned paths
2. systemctl commands (start, stop, restart, status, enable, disable)
3. Docker daemon operations
4. Network configuration (ip -6 addr add, ip -6 route add)

**Pre-Commit Checklist Addition**:
- [ ] All system-level file operations use sudo tee or run with root privileges
- [ ] All systemctl commands prefixed with sudo
- [ ] All operations in /etc directories use sudo
- [ ] Script documents sudo requirement in header comments

**Added**: 2025-10-11
**Issue**: deploy-sync-cluster.sh failed with "Permission denied"
**Resolution**: Added sudo to all system-level operations
**Lesson**: Never assume deployment scripts run as root - always use explicit sudo

---

## 🔌 Supabase Connection Standards

### Database Connection URLs

**CRITICAL**: Supabase has TWO connection methods with DIFFERENT URL formats.

#### Direct Connection (IPv6 - Recommended)

```bash
# Format for direct connection
postgresql://[USER]:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres

# Examples
ADMIN_URL="postgresql://postgres:${PASSWORD}@db.dgjvrkoxxmbndvtxvqjv.supabase.co:5432/postgres"
SYNC_URL="postgresql://sync_service:${PASSWORD}@db.dgjvrkoxxmbndvtxvqjv.supabase.co:5432/postgres"
```

**Requirements**:
- IPv6 connectivity required
- All PostgreSQL features supported
- Lower latency
- Custom roles work without modification

#### Pooler Connection (IPv4 - Fallback)

```bash
# Format for pooler connection - MUST include PROJECT_REF in username
postgresql://[USER].[PROJECT_REF]:[PASSWORD]@[REGION].pooler.supabase.com:5432/postgres

# Examples
ADMIN_URL="postgresql://postgres.dgjvrkoxxmbndvtxvqjv:${PASSWORD}@aws-1-us-east-2.pooler.supabase.com:5432/postgres"
SYNC_URL="postgresql://sync_service.dgjvrkoxxmbndvtxvqjv:${PASSWORD}@aws-1-us-east-2.pooler.supabase.com:5432/postgres"
```

**CRITICAL DIFFERENCE**: Username must be `[USER].[PROJECT_REF]` not just `[USER]`

**Requirements**:
- IPv4 connectivity
- Limited PostgreSQL features (transaction pooling mode)
- Higher latency through proxy
- **MUST append project reference to username**

### Common Mistake: "Tenant or user not found"

**Symptom**: Connection fails with error:
```
FATAL: Tenant or user not found
```

**Cause**: Using pooler connection without project reference in username

**Wrong**:
```bash
# ❌ This will fail with pooler
postgresql://sync_service:password@aws-1-us-east-2.pooler.supabase.com:5432/postgres
```

**Correct**:
```bash
# ✅ This works with pooler
postgresql://sync_service.dgjvrkoxxmbndvtxvqjv:password@aws-1-us-east-2.pooler.supabase.com:5432/postgres
```

### Testing Connection Format

```bash
# Test direct connection (IPv6)
docker run --rm postgres:15-alpine psql \
  "postgresql://sync_service:PASSWORD@db.PROJECT_REF.supabase.co:5432/postgres" \
  -c "SELECT current_user;"

# Test pooler connection (IPv4)
docker run --rm postgres:15-alpine psql \
  "postgresql://sync_service.PROJECT_REF:PASSWORD@REGION.pooler.supabase.com:5432/postgres" \
  -c "SELECT current_user;"
```

### Deployment Script Standards

When building connection URLs, always check IPv6 availability first:

```bash
if [ "$USE_IPV6_CONNECTION" = true ]; then
    # Direct connection - no project ref needed in username
    SYNC_URL="postgresql://sync_service:${PASSWORD}@db.${PROJECT_REF}.supabase.co:5432/postgres"
else
    # Pooler connection - MUST include project ref in username
    SYNC_URL="postgresql://sync_service.${PROJECT_REF}:${PASSWORD}@${REGION}.pooler.supabase.com:5432/postgres"
fi
```

**Pre-Commit Checklist Addition**:
- [ ] Pooler URLs use `USER.PROJECT_REF` format for username
- [ ] Direct URLs use `db.PROJECT_REF.supabase.co` hostname
- [ ] Script warns when using pooler fallback
- [ ] Passwords are URL-encoded before use

---

**Added**: 2025-10-11
**Issue**: Pooler connection failed with "Tenant or user not found"
**Resolution**: Added project reference to username (sync_service.PROJECT_REF)
**Lesson**: Supabase pooler has different authentication format than direct connection

